---
title: "Lab 1 Cancer EDA"
author: "Daniel Rasband, Subha Vadakkumkoor, Hong Yang"
date: \today
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(car)
library(corrplot)
```

## Problem Set

We were hired by a health government agency to understand and predict cancer mortality rates:

1. Understand factors that predict cancer mortality rates
2. Identity communities for social interventions
3. Understand which interventions are likely to have the impact

### Objective of this Lab

Perform an exploratory analysis to understand how county-level characteristics are related to cancer mortality.

## Data Set

```{r load}
canc.dat <- read.csv('cancer.csv', header = TRUE)
```

### Summary

```{r}
summary(canc.dat)
```

### Variables

```{r}
names(canc.dat)
```

#### Meanings

The X column appears to be a simple auto-incremented ID, so it is ignored. We are assuming that the rest of the columns have the following meanings. If these assumptions prove to be incorrect, the analysis may also be incorrect.

* `avgAnnCount`: Average cancer total incidences per year from 2009-2013.
* `medIncome`: Median Income
* `popEst2015`: Estimated population in 2015
* `povertyPercent`: Percentage of population below poverty level
* `binnedInc`: Income range
* `MedianAge`: Median Age
* `MedianAgeMale`: Median Age of Males
* `MedianAgeFemale`: Median Age of Females
* `Geography`: County, State
* `AvgHouseholdSize`: Average Household Size
* `PercentMarried`: Percent of population that is married
* `PctNoHS18_24`: Percent of population, ages 18-24, that hasn't graduated from high school.
* `PctHS18_24`: Percent of population, ages 18-24, that has graduated from high school.
* `PctSomeCol18_24`: Percentage of 18-24-year-olds that have some college education.
* `PctBachDeg18_24`: Percentage of 18-24-year-olds that have a bachelor's degree.
* `PctHS25_Over`: Percentage of population, 25 and older, graduated from high school.
* `PctBachDeg25_Over`: Percentage of population, 25 and older, graduated from college.
* `PctEmployed16_Over`: Percentage of population, 16 and older, that is employed.
* `PctUnemployed16_Over`: Percentage of population, 16 and older, that is unemployed.
* `PctPrivateCoverage`: Percentage of population with private insurance coverage.
* `PctEmpPrivCoverage`: Percentage of population with private insurance coverage from employment.
* `PctPublicCoverage`: Percentage of population with public insurance coverage.
* `PctWhite`: Percentage of population that is white.
* `PctBlack`: Percentage of population that is black.
* `PctAsian`: Percentage of population that is asian.
* `PctOtherRace`: Percentage of population that is not white, black, or asian.
* `PctMarriedHouseholds`: Percentage of the population that is in a married household.
* `BirthRate`: The birth rate, unknown basis.
* `deathRate`: The death rate, per 100,000 people.

The most questionable of the above assumptions is that of the `deathRate`, but comparing the numbers with those in [a PDF of death-related statistics for Los Angeles county](http://publichealth.lacounty.gov/dca/data/documents/mortalitypresentation2012.pdf), and by using a bit of common sense, it appears that the rate is per 100,000 people. The birth rate is similarly questionable, but by using Los Angeles's data, it appears that the number is per 100 women, 15-44. This could be a bit of a problem since we don't know the population of women in that age range, except that we will not be using that data point in this exploratory analysis, so we will ignore it.

Another fundamentally questionable aspect of the data is that most data points do not have a reference year. We are assuming 2015 for those data, but that may not be accurate.

### Number of Observations

There are 3047 observations in the data set.

```{r}
nrow(canc.dat)
```

The number of counties equals the number of observations, so no county has multiple rows of data.

```{r}
length(unique(canc.dat$Geography)) == nrow(canc.dat)
```

## Data Cleaning

While perusing the data, we have found that there are some pieces that need to be cleaned up. First of all, the `avgAnnCount` has 206 rows that are 1) the exact same number, and 2) greater than the actual population. This indicates to us that those values were missing from the data and had been assigned a default value (`1962.668`). Because the `avgAnnCount` is crucial to this analysis, and those values have proven nonsensical, we will have to remove them:

```{r}
canc.dat[canc.dat$avgAnnCount > canc.dat$popEst2015, c('X', 'avgAnnCount')]
```

```{r}
fixed.dat <- subset(canc.dat, avgAnnCount != canc.dat$avgAnnCount[116])
nrow(fixed.dat)
```

The `PctSomeCol18_24` variable has a large majority of missing values, so we are opting to remove the column entirely for the dataset. This has potential to make it more difficult to find correlation between cancer death rates and educational status, but the data is too sparse to use.

```{r}
fixed.dat = subset(fixed.dat, select = -c(PctSomeCol18_24))
names(fixed.dat)
```

Lastly, it appears that `MedianAge` is set to months, rather than years, in a number of cases, so we adjust those rows:

```{r}
age.outliers = fixed.dat$MedianAge > 100
fixed.dat$MedianAge[age.outliers] = fixed.dat$MedianAge[age.outliers] / 12
# Sanity check
summary(fixed.dat$MedianAge, fixed.dat$MedianAgeFemale, fixed.dat$MedianAgeMale)
```

## Extra Variables

Our task is to look for correlations between cancer death rate and other factors, but cancer death rate is not given. This is the biggest issue with the data and our assumption here greatly reduces the effectiveness of the exploratory data analysis. Our effort here will be to compute the rate of cancer incidents to deaths, and use that as a measure of approximately how frequent cancer causes death.

```{r}
# The percentage of the population that had cancer. This may be flawed, because some people may have been diagnosed twice or more.
fixed.dat$cancerRate = fixed.dat$avgAnnCount / fixed.dat$popEst2015
summary(fixed.dat$cancerRate)
```

Cancer incidents are very strongly correlated with populations, which means that the more people, the more cancer incidents.

```{r}
cor(fixed.dat$avgAnnCount, fixed.dat$popEst2015)
```

```{r}
# The percentage of each population that died.
fixed.dat$realDeathRate = fixed.dat$deathRate / 100000
summary(fixed.dat$realDeathRate)
```

```{r}
# The ratio of deaths (of any kind) to cancer incidents
fixed.dat$deathToCancerRate = fixed.dat$realDeathRate / fixed.dat$cancerRate
summary(fixed.dat$deathToCancerRate)
```

### Income / Poverty & Insurance Coverage

When cancerRate is high, PctPublicCoverage is high and medIncome is relativly low, we will further examine them.  We also noticed that public coverage and private coverage seem mutually exclusive.

```{r}
cor(fixed.dat[ , c("cancerRate","PctPrivateCoverage","PctPublicCoverage","povertyPercent", "medIncome")], use = "complete.obs")
```

This initial examination shows there are indication that PctPublicCoverage and medIncome have impact on cancerRate, especailly few outliers.  Other variables don't have much strong impact from these plots.  We will examine further.

```{r}
hist(fixed.dat$cancerRate, main = "Cancer Rate", xlab = NULL)
```

```{r}
boxplot(fixed.dat$cancerRate ~ fixed.dat$PctPublicCoverage,
        main = "Public Insurance Coverage vs Cancer Rate",
        xlab = "% Public Coverage",
        ylab = "Cancer Rate")
```

```{r}
boxplot(fixed.dat$cancerRate ~ fixed.dat$medIncome, main = "Median Income vs Cancer Rate", xlab = "Median Income", ylab = "Cancer Rate")
```

```{r}
plot(fixed.dat$PctPublicCoverage, main = "Public Insurance Coverage")
```

```{r}
plot(fixed.dat$PctPrivateCoverage, main = "Private Insurance Coverage")
```

```{r}
hist(fixed.dat$povertyPercent, breaks = 10, xlab = NULL, main = "Poverty Percentage")
```

Based on the fact that we are examine the variables which are impacting high cancer rate, we will take a closer look at the data for avgAnnCount greater than 250. 250 cancer incidents per county anually is still relatively high, we pick this number because it's between median and mean and closer to median. The mean is much higher than the median indicates the one plus few more extreamly high cancer incident numbers, by selecting the data above the mean will miss the chance with most representative data.

```{r}
summary(fixed.dat$avgAnnCount)
```

```{r}
highInc.dat = fixed.dat[fixed.dat$avgAnnCount > 250,c("avgAnnCount", "cancerRate", "Geography", "medIncome", "PctPublicCoverage", "PctPrivateCoverage", "povertyPercent", "AvgHouseholdSize", "deathToCancerRate")]
nrow(highInc.dat)
```

Lower medIncome and higher PctPublicCoverage have the most impact on cancerRate.  Public incurance often have limited coverage for cancer treatment.  Private coverage doesn't seem to have strong impact on cancerRate as well as povertyPercent.

```{r}
plot(highInc.dat$cancerRate ~ highInc.dat$medIncome,
     main = "Median Income to Cancer Rate",
     xlab = "Median Income",
     ylab = "Cancer Rate",
     las = 1,
     xlim = c(120000, 30000),
     col = 4)
abline(lm(highInc.dat$cancerRate ~ highInc.dat$medIncome), col = 2)
```

```{r}
plot(highInc.dat$cancerRate ~ highInc.dat$PctPublicCoverage,
     main = "Public Insurance Coverage vs Cancer Rate",
     xlab = "Public Coverage %",
     ylab = "Cancer Rate",
     col = 4)
abline(lm(highInc.dat$cancerRate ~ highInc.dat$PctPublicCoverage), col = 2)
```

```{r}
plot(highInc.dat$cancerRate ~ highInc.dat$PctPrivateCoverage,
     main = "Private Insurance Coverage vs Cancer Rate",
     xlab = "Private Coverage %",
     ylab = "Cancer Rate",
     col = 4)
abline(lm(highInc.dat$cancerRate ~ highInc.dat$PctPrivateCoverage), col = 2)
```

```{r}
plot(highInc.dat$cancerRate ~ highInc.dat$povertyPercent,
     main = "Poverty to Cancer Rate",
     xlab = "Poverty %",
     ylab = "Cancer Rate",
     col = 4)
abline(lm(highInc.dat$cancerRate ~ highInc.dat$povertyPercent), col = 2)
```

Now let's examine deathToCancerRate with medIncome and PctPublicCoverage.  The results are little lesser impact compare to the previous plots.  Since the data are not giving cancer motality, this results suggest there are other factors to death rate, but medIncome and PctPublicCoverage are still impacting number of cancer incident per county.

```{r}
plot(highInc.dat$deathToCancerRate ~ highInc.dat$medIncome,
     main = "Median Income to Cancer to Death Rate",
     xlab = "Median Income",
     ylab = "Cancer to Death Rate",
     las = 1,
     xlim = c(120000, 30000),
     col = 4)
abline(lm(highInc.dat$deathToCancerRate ~ highInc.dat$medIncome), col = 2)
```

```{r}
plot(highInc.dat$deathToCancerRate ~ highInc.dat$PctPublicCoverage,
     main = "Public Insurance Coverage vs Cancer to Death Rate",
     xlab = "Public Coverage %",
     ylab = "Cancer to Death Rate",
     col = 4)
abline(lm(highInc.dat$deathToCancerRate ~ highInc.dat$PctPublicCoverage), col = 2)
```

### Employment & Race

Need to add imputation of missing values of field PctEmployed16_Over.
Looks like PctSomeCol18_24 has text "NA" as opposed to N/A.

##  Data Understanding and Sanity checks

There are no cases where avgConnCount is greater than the population. Although avgAnnCount is from 2009-2013 and popEst2015 is from 2015, this provides better confidence in the avgConnCount field

```{r}
nrow(subset(fixed.dat,avgAnnCount>popEst2015))
```

There are several values of binnedInc and Geography that average of cancer counts or death rates cannot be calculated for each group as is.

```{r}
length(fixed.dat$binnedInc)
```

Histograms of all numeric fields are plotted below.

```{r}
numeric_columns <- sapply(fixed.dat, is.numeric)
data_to_plot <- names(fixed.dat[,numeric_columns])
for (var in data_to_plot)
{
  hist(fixed.dat[ , var],main=var)
}
```

Create indicator for population percent without public or private insurance

```{r}
fixed.dat$No_insurance<-100-(fixed.dat$PctPrivateCoverage+fixed.dat$PctPublicCoverage)
```

Percentage fields related to race are mutually exhaustive and show that data is complete in this regard

```{r}
nrow(subset(fixed.dat, (100-fixed.dat$PctWhite + fixed.dat$PctBlack + fixed.dat$PctAsian + fixed.dat$OtherRate)<0))
```

#### Exploring relationship between variables with cancer mortality

To get a better understanding of the data in hand and how the different variables are related to each other (and cancer death rate), we do a correlation analysis. Below is a short summary

1. avgAnnCount is highly correlated to popEst2015 (0.98)
2. medIncome is  correlated negatively to povertyPercent (-0.78) and PctPublicCoverage, and positively correlated to PctBachDeg25_Over,  PctEmployed16_Over, PctPrivateCoverage, PctEmpPrivCoverage (~0.7). These make intuitive sense.
3. MedianAge, MedianAgeMale and MedianAgeFemale are all highly correlated to each other, with over 0.9 Rsquared
4. povertyPercent is negatively correlated to PercentMarried and PercentMarriedHouseholds with an R-square of -0.6
5. PctBachDeg25_Over and PctBachDeg18_24 are positively correlated at 0.6 R-square
6. PctHS25_Over and PctBachDeg25_Over are negatively correlated with -0.6 R-square. This is not intuitive
7. PctMarried is positively correlated with PctWhite and negatively with PctBlack

```{r}
numeric_cols<-sapply(fixed.dat, is.numeric)
coeff<-round(corr_coeff<-cor(fixed.dat[,numeric_cols],use="pairwise.complete.obs"),3)
corrplot(coeff)
```

#### Impact of race related variables on cancer death rate

PctWhite and PctBlack are very highly correlated (over 0.8). We can check impact of anyone here PctWhite as PctWhite and PctBlack are the two top groups. Created an indicator to separate population with with less than 40 pct white vs 40 or more pct White. Comparing average cancer death rate between these two we see that population with less than 40pct White have higher cancer death rate (0.439) compared to that of population with over 40pct White (0.338).

```{r}
fixed.dat$chosen_field<-fixed.dat$deathToCancerRate
library(car)
scatterplotMatrix(~ fixed.dat$chosen_field + fixed.dat$PctWhite + fixed.dat$PctBlack + fixed.dat$PctAsian + fixed.dat$PctOther)
plot(fixed.dat$PctWhite,fixed.dat$chosen_field,main="CancerDeathRate by PctWhite")
fixed.dat$Atleast_40pct_White<-1
fixed.dat$Atleast_40pct_White[fixed.dat$PctWhite<40]<-0
aggregate(fixed.dat$chosen_field,list(fixed.dat$Atleast_40pct_White),mean)
```

#### Impact of education related variables on cancer death rate

Looking at scatter plots and corelations, it does not seem like education has any key role in influencing cancer death rates. There may be an indirect way of how higher education would mean a higher income and better insurance, but that is not captured in the relationship between the education fields and the cancer death rate

```{r}
edu_fields<-c("PctBachDeg25_Over","PctNoHS18_24","PctNoHS18_24","PctHS18_24","PctBachDeg18_24","PctHS25_Over")
scatterplotMatrix(~ chosen_field + PctBachDeg25_Over + PctNoHS18_24 + PctHS18_24 + PctBachDeg18_24 + PctHS25_Over  , data = fixed.dat)
round(cor(fixed.dat$chosen_field,fixed.dat[,edu_fields],use="pairwise.complete.obs"),3)
```

### Family Structure

There are two three variables related to family structure: `AvgHouseholdSize`, `PercentMarried`, `PctMarriedHouseholds`.

```{r}
# Look for outliers
boxplot(fixed.dat$AvgHouseholdSize)
```

Average household size is close 0 for many observations, but really these numbers shouldn't be less than 1. Instead of making some assumption about what the reasoning is for these numbers, we can remove them from this particular set of analyses.

```{r}
household.dat <- subset(fixed.dat, AvgHouseholdSize >= 1)
boxplot(household.dat$AvgHouseholdSize)
```

```{r}
scatterplotMatrix(~ cancerRate + deathToCancerRate + AvgHouseholdSize,
                  data = household.dat)
```

It appears that both cancer rates decrease and death to cancer rates increase with increases in household size.

```{r}
cor(household.dat$cancerRate, household.dat$AvgHouseholdSize)
```

```{r}
cor(household.dat$deathToCancerRate, household.dat$AvgHouseholdSize)
```

What does this mean? It _could_ mean that there are fewer incidents of cancer in larger households. This is most likely because larger households on average means younger people. Let's test that assumption.

```{r}
scatterplotMatrix(~ AvgHouseholdSize + MedianAge, data = household.dat)
```

This is reasonably well correlated:

```{r}
cor(household.dat$AvgHouseholdSize, household.dat$MedianAge)
```

Based on that correlation, it can't be said that household size alone contributes to lower rates of cancer. Interestingly, the ratio of death to cancer increases with larger household sizes. What could explain this? It could be that there are more deaths unrelated to cancer with younger groups. This seems feasible, since younger groups of people are less likely to have routine, easily detectable cancer.

What about marriage?

```{r}
scatterplotMatrix(~ cancerRate + deathToCancerRate + PercentMarried, data = fixed.dat)
```

```{r}
cor(fixed.dat$cancerRate, fixed.dat$PercentMarried)
```

```{r}
cor(fixed.dat$deathToCancerRate, fixed.dat$PercentMarried)
```

The correlation between percent married and cancer rate is only ~0.2. There may be something here, but it's pretty weak. The correllation between the death to cancer rate and percent married is slightly higher, at -0.34. This could mean that there is a slight tendency for a lower incidence of cancer mortality for married couples. This could possibly be explained by earlier detection, stronger motivation in the form of spousal urging to take early and strong action to conquer the cancer, etc. Could there be any confounding factors, such as the age of the population?

```{r}
scatterplotMatrix(~ deathToCancerRate + PercentMarried + MedianAge, data = fixed.dat)
```

It appears that median age percent married are positively correlated, more so than death to cancer rate and percent married.

```{r}
cor(fixed.dat$PercentMarried, fixed.dat$MedianAge)
```

Again, as ages increase, the percentage of married people increases, so the two are dependent, and cancer mortality rates can't necessarily be attributed to marriage or age alone.
